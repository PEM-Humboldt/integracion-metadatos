Estructura y descripción de los metadatos de Ceiba
================
Marius Bottin
2025-01-31

- [1 Datadir en el servidor Ceiba](#1-datadir-en-el-servidor-ceiba)
  - [1.1 Descripción](#11-descripción)
  - [1.2 Extracción de los metadatos](#12-extracción-de-los-metadatos)
- [2 Analisis de los metadatos](#2-analisis-de-los-metadatos)
- [3 Exportation of a table with values and references (dataset and
  variables)](#3-exportation-of-a-table-with-values-and-references-dataset-and-variables)

``` r
require(RPostgreSQL)
```

    ## Loading required package: RPostgreSQL

    ## Loading required package: DBI

``` r
require(dm)
```

    ## Loading required package: dm

    ## 
    ## Attaching package: 'dm'

    ## The following object is masked from 'package:stats':
    ## 
    ##     filter

``` r
require(png)
```

    ## Loading required package: png

``` r
knitr::opts_chunk$set(cache=F,tidy.opts = list(width.cutoff = 70),
                     tidy = TRUE,
                     max.print=50,fig.path="./Fig/explor_ceiba_",echo=T,
                     collapse=F, echo=T)
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "footnotesize","\n\n", x, "\n\n \\normalsize\n\n")
})
```

# 1 Datadir en el servidor Ceiba

## 1.1 Descripción

Todos los datos de Ceiba están organizados como carpetas en el datadir
del servidor. Se maneja después con el sistema Integrated Publishing
Toolkit desarrollado por GBIF.

En cada carpeta (cada juego de datos), podemos encontrar:

- el archivo comprimido que contiene los archivos y los metadatos en
  formato DarwinCore completo.
- el archivo `eml.xml` que contiene los metadatos, y todas las versiones
  del archivo (con los nombres `eml-1.xml`, `eml-2.xml` etc)
- el archivo `publication.log` que contiene el historial de
  publicación/modificación del juego de datos
- archivos de descripción de los juegos de datos en “Rich Text Format”
  (rtf), tambien para cada versión publicada
- archivos de administración de datos y metadatos `resource.xml`
- una carpeta `sources` que contiene los datos (?)

## 1.2 Extracción de los metadatos

En ssh, accedemos al servidor de ceiba desde la red del instituto:

``` bash
ssh integracion@192.168.11.74
```

Extraemos 3 archivos:

- un archivo que tiene las direcciones de los archivos “eml.xml” y sus
  contenidos
- un archivo que contiene las direcciones de los archivos “resource.xml”
  y sus contenidos
- un catalogo de todos los archivos presentes en la carpeta de datos
  manejada por el ipt

Esos 2 archivos se pueden obtener con:

``` bash
find /home/pem/datadir/ -name eml.xml -exec bash file_and_content.sh {} \; >file_and_content_result_eml 2> errors_find_file_and_content_eml
fimd /home/pem/datadir/ -name resource.xml  -exec bash file_and_content.sh {} \; >file_and_content_result_resource 2> errors_find_file_and_content_resource
find -type f /home/pem/datadir/ > result_find
```

Los archivos se pueden descargar desde la red del instituto, gracias al
applicativo scp, que funciona a través de ssh.

# 2 Analisis de los metadatos

``` r
result_find <- readLines("../../../data_metadatos_catalogos/ceiba/result_find")
meta_ceiba <- readLines("../../../data_metadatos_catalogos/ceiba/file_and_content_result_eml")
```

Numero de archivos de metadatos

``` r
sum(grepl("---file:.*---", meta_ceiba))
```

    ## [1] 1051

We search for the names/pathes of the files and we create the tables
describing the adresses in the R object

``` r
nameFilesAddr <- grep("---file:.*---", meta_ceiba)
addresses_xml <- data.frame(file = sub("^---file:(.*)---$", "\\1", meta_ceiba[nameFilesAddr]),
    beg = nameFilesAddr + 1, end = c(nameFilesAddr[2:length(nameFilesAddr)] -
        1, length(meta_ceiba)))
```

Checking integrity and correspondances with the other objects

``` r
any(duplicated(addresses_xml$file))
```

    ## [1] FALSE

``` r
match(addresses_xml$file, result_find)
```

    ##    [1]     4    22    72    89   145   185   198   209   251   270   285   308
    ##   [13]   323   334   356   394   410   434   442   482   516   527   581   597
    ##   [25]   601   609   616   629   651   661   680   697   712   733   751   768
    ##   [37]   779   795   808   849   890   900   923   956   975   990  1009  1031
    ##   [49]  1050  1083  1104  1119  1131  1169  1180  1225  1258  1278  1303  1324
    ##   [61]  1349  1366  1390  1413  1436  1459  1502  1533  1564  1591  1618  1641
    ##   [73]  1664  1691  1722  1745  1784  1808  1843  1866  1907  1917  1956  1985
    ##   [85]  2019  2061  2099  2135  2174  2207  2237  2267  2303  2336  2366  2392
    ##   [97]  2411  2426  2456  2497  2535  2595  2606  2625  2674  2703  2711  2752
    ##  [109]  2765  2777  2790  2807  2843  2866  2886  2897  2921  2936  2944  2949
    ##  [121]  2994  3016  3052  3063  3082  3112  3123  3130  3158  3176  3188  3222
    ##  [133]  3237  3257  3272  3303  3333  3359  3407  3457  3508  3557  3595  3629
    ##  [145]  3661  3728  3765  3816  3853  3895  3923  3958  3981  3999  4011  4020
    ##  [157]  4032  4055  4071  4079  4104  4118  4129  4140  4167  4188  4221  4231
    ##  [169]  4246  4263  4302  4353  4380  4415  4446  4458  4469  4480  4491  4508
    ##  [181]  4529  4546  4560  4577  4592  4604  4627  4653  4671  4679  4693  4706
    ##  [193]  4716  4736  4765  4784  4798  4810  4826  4839  4856  4892  4933  4972
    ##  [205]  5010  5046  5070  5109  5150  5184  5206  5243  5276  5289  5296  5304
    ##  [217]  5320  5332  5345  5358  5390  5425  5448  5463  5478  5488  5498  5506
    ##  [229]  5514  5526  5534  5544  5554  5561  5573  5585  5598  5616  5630  5645
    ##  [241]  5655  5668  5684  5692  5706  5723  5741  5762  5785  5822  5857  5880
    ##  [253]  5896  5914  5928  5935  5955  5970  5990  6005  6023  6038  6055  6060
    ##  [265]  6081  6098  6117  6135  6147  6160  6178  6201  6232  6248  6260  6294
    ##  [277]  6338  6384  6416  6449  6481  6507  6532  6556  6576  6592  6608  6626
    ##  [289]  6642  6654  6683  6712  6739  6754  6768  6780  6804  6821  6840  6857
    ##  [301]  6873  6885  6906  6927  6941  6950  6982  7022  7070  7121  7162  7201
    ##  [313]  7219  7246  7265  7304  7332  7350  7364  7376  7393  7412  7430  7449
    ##  [325]  7462  7476  7491  7512  7534  7553  7581  7605  7625  7646  7674  7702
    ##  [337]  7718  7728  7735  7751  7769  7787  7807  7835  7858  7883  7906  7925
    ##  [349]  7958  7987  8008  8025  8045  8070  8083  8121  8138  8157  8171  8190
    ##  [361]  8228  8254  8267  8278  8307  8326  8340  8351  8357  8365  8374  8381
    ##  [373]  8388  8404  8422  8437  8462  8479  8493  8503  8517  8541  8558  8572
    ##  [385]  8585  8607  8624  8637  8656  8680  8715  8750  8765  8779  8804  8821
    ##  [397]  8847  8880  8917  8942  8945  8973  9011  9039  9055  9080  9103  9114
    ##  [409]  9149  9185  9203  9249  9278  9314  9340  9358  9376  9388  9414  9437
    ##  [421]  9479  9516  9540  9559  9578  9589  9607  9619  9644  9694  9729  9745
    ##  [433]  9764  9784  9804  9826  9856  9887  9912  9928  9947  9968  9996 10014
    ##  [445] 10021 10048 10083 10116 10132 10156 10176 10187 10198 10239 10266 10285
    ##  [457] 10297 10317 10337 10361 10393 10419 10458 10477 10499 10530 10564 10586
    ##  [469] 10621 10653 10686 10705 10712 10722 10740 10751 10760 10769 10777 10801
    ##  [481] 10845 10888 10932 10981 11025 11062 11093 11147 11199 11241 11278 11318
    ##  [493] 11358 11390 11447 11498 11525 11537 11554 11572 11589 11615 11632 11679
    ##  [505] 11705 11717 11743 11765 11798 11815 11841 11864 11887 11908 11935 11954
    ##  [517] 11977 12017 12042 12059 12077 12091 12109 12143 12169 12189 12202 12240
    ##  [529] 12291 12321 12343 12356 12373 12399 12418 12436 12452 12463 12474 12523
    ##  [541] 12557 12599 12632 12650 12660 12690 12716 12761 12808 12834 12846 12862
    ##  [553] 12883 12902 12913 12919 12931 12936 12976 13003 13019 13036 13045 13055
    ##  [565] 13105 13153 13194 13215 13259 13289 13307 13320 13329 13340 13356 13370
    ##  [577] 13390 13418 13447 13464 13477 13492 13506 13521 13533 13546 13565 13588
    ##  [589] 13605 13616 13629 13644 13669 13685 13699 13714 13741 13778 13816 13844
    ##  [601] 13863 13890 13913 13934 13950 13968 13985 14009 14034 14083 14112 14127
    ##  [613] 14143 14160 14177 14198 14226 14258 14283 14300 14317 14335 14350 14365
    ##  [625] 14390 14416 14437 14452 14472 14489 14499 14506 14520 14527 14537 14558
    ##  [637] 14601 14630 14645 14662 14681 14698 14717 14732 14759 14783 14801 14817
    ##  [649] 14827 14834 14854 14880 14901 14916 14941 14972 14995 15011 15025 15038
    ##  [661] 15065 15088 15118 15150 15174 15193 15212 15229 15255 15273 15291 15305
    ##  [673] 15325 15355 15375 15391 15421 15446 15466 15479 15504 15532 15554 15567
    ##  [685] 15571 15582 15599 15622 15638 15664 15684 15717 15743 15766 15783 15806
    ##  [697] 15831 15860 15893 15918 15942 15962 15976 15988 16003 16016 16039 16064
    ##  [709] 16092 16119 16133 16159 16186 16208 16225 16238 16273 16313 16337 16368
    ##  [721] 16384 16406 16427 16449 16479 16509 16524 16551 16569 16588 16610 16625
    ##  [733] 16635 16647 16660 16671 16695 16719 16758 16798 16822 16836 16848 16858
    ##  [745] 16868 16881 16896 16936 16964 16977 17026 17065 17105 17131 17156 17191
    ##  [757] 17213 17228 17242 17257 17268 17286 17324 17364 17389 17411 17435 17453
    ##  [769] 17471 17493 17531 17571 17588 17607 17636 17653 17673 17690 17735 17801
    ##  [781] 17847 17875 17888 17895 17908 17942 17961 17975 18000 18016 18028 18035
    ##  [793] 18048 18064 18081 18099 18124 18144 18162 18184 18202 18217 18234 18245
    ##  [805] 18259 18277 18289 18303 18321 18345 18359 18370 18382 18393 18417 18431
    ##  [817] 18438 18476 18530 18580 18620 18644 18664 18677 18690 18705 18720 18741
    ##  [829] 18780 18805 18841 18880 18912 18941 18966 18982 19002 19014 19028 19043
    ##  [841] 19073 19112 19148 19168 19188 19221 19247 19273 19290 19301 19319 19343
    ##  [853] 19360 19379 19415 19439 19453 19490 19536 19575 19598 19613 19629 19644
    ##  [865] 19660 19672 19695 19724 19765 19795 19812 19825 19844 19863 19885 19904
    ##  [877] 19917 19937 19954 19966 19978 19991 20020 20060 20099 20126 20153 20182
    ##  [889] 20212 20229 20242 20254 20264 20284 20298 20305 20329 20353 20375 20399
    ##  [901] 20424 20458 20481 20500 20519 20549 20569 20584 20602 20628 20645 20655
    ##  [913] 20679 20714 20735 20751 20772 20794 20814 20829 20851 20891 20918 20930
    ##  [925] 20945 20966 20984 21012 21038 21058 21080 21100 21121 21136 21159 21177
    ##  [937] 21192 21216 21232 21255 21282 21300 21337 21368 21381 21390 21400 21416
    ##  [949] 21426 21442 21452 21463 21474 21490 21512 21527 21543 21561 21578 21594
    ##  [961] 21608 21620 21634 21656 21666 21680 21689 21705 21723 21737 21755 21763
    ##  [973] 21780 21785 21800 21810 21820 21828 21836 21860 21879 21892 21911 21919
    ##  [985] 21926 21937 21959 21972 21987 22002 22024 22046 22061 22076 22091 22114
    ##  [997] 22131 22146 22159 22172 22185 22203 22218 22233 22246 22257 22269 22280
    ## [1009] 22291 22310 22326 22344 22362 22378 22394 22410 22427 22441 22460 22473
    ## [1021] 22479 22493 22513 22521 22534 22548 22566 22577 22591 22601 22615 22629
    ## [1033] 22637 22644 22660 22668 22679 22688 22710 22720 22735 22746 22760 22770
    ## [1045] 22780 22782 22792 22802 22812 22826 22832

There might be a problem when there is an empty xml. After manual
checking, we realize that this problem creates an end before the beg, so
to avoid these lines in the rest of the code, we just suppress these
cases in the addresses_xml object:

``` r
w_empty <- which((addresses_xml$beg[1:(nrow(addresses_xml) - 1)] + 1) ==
    addresses_xml$beg[2:nrow(addresses_xml)])
addresses_xml[(w_empty - 2):(w_empty + 2), ]
```

    ##                                                                       file
    ## 1048                   /home/pem/datadir/resources/yaguara_sonidos/eml.xml
    ## 1049               /home/pem/datadir/resources/frutos-corozo_cesar/eml.xml
    ## 1050            /home/pem/datadir/resources/cacay-moriche_guaviare/eml.xml
    ## 1051 /home/pem/datadir/resources/reserva-natural_lostucanes-boyaca/eml.xml
    ## NA                                                                    <NA>
    ##         beg    end
    ## 1048 451243 451646
    ## 1049 451648 451909
    ## 1050 451911 451910
    ## 1051 451912 452135
    ## NA       NA     NA

``` r
addresses_xml[addresses_xml$beg > addresses_xml$end, ]
```

    ##                                                            file    beg    end
    ## 1050 /home/pem/datadir/resources/cacay-moriche_guaviare/eml.xml 451911 451910

``` r
addresses_xml <- addresses_xml[addresses_xml$beg < addresses_xml$end, ]
```

Separating by origin files:

``` r
xml_files <- apply(addresses_xml, 1, function(a, rl) paste(rl[a[2]:a[3]],
    sep = "\n", collapse = "\n"), rl = meta_ceiba)
names(xml_files) <- addresses_xml$file
```

Then reading the xml code:

``` r
require(XML)
```

    ## Loading required package: XML

``` r
require(xml2)
```

    ## Loading required package: xml2

``` r
xml_list <- lapply(xml_files, function(x) xmlToList(xmlParse(x)))
```

I gotta check this part because it does not make sense: this only take
the large categories which are:

- dataset
- additionalMetadata
- .attrs

``` r
names1<-names(xml_list[[1]])
names_all<-lapply(xml_list,names) 
sapply(names_all,function(x,y)!all(y==x),y=names1)
(names_fields<-unique(Reduce(c,names_all)))
mostComplete<-which.max(sapply(names_all,function(x,y)sum(y%in%x),y=names_fields))
  
```

Seems that part is useless as well:

``` r
level1<-data.frame(
  name=names_fields,
  hasValue=F
)
A<-sapply(xml_list,names)
A_corres<-data.frame(
  lev0_nb=rep(1:length(A),sapply(A,length)),
  lev1_nb=unlist(lapply(A,function(x)1:length(x))),
  level1_match=unlist(lapply(A,function(x,y)match(x,y),y=level1$name))
)
LIST<- ISNULL <- logical(length=nrow(A_corres))
LENGTH <- DEPTH <- numeric(length=nrow(A_corres))
# NAMES <- list()
# for(i in 1:nrow(A_corres))LIST[i]<-is.list(xml_list[[A_corres[i,1]]][[A_corres[i,2]]])
# for(i in 1:nrow(A_corres))ISNULL[i]<-is.null(xml_list[[A_corres[i,1]]][[A_corres[i,2]]])
# for(i in 1:nrow(A_corres))LENGTH[i]<-length(xml_list[[A_corres[i,1]]][[A_corres[i,2]]])
# for(i in 1:nrow(A_corres))DEPTH[i]<-ldepth(xml_list[[A_corres[i,1]]][[A_corres[i,2]]])
# for(i in 1:nrow(A_corres))NAMES[[i]]<-names(xml_list[[A_corres[i,1]]][[A_corres[i,2]]])
# tapply(LENGTH,level1[A_corres[,3],"name"],table)
# table(unlist(NAMES[A_corres$level1_match==1]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==2]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==3]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==4]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==5]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==6]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==7]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==8]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==9]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==10]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==11]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==12]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==13]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==14]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==15]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==16]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==17]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==18]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==19]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==20]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==21]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==22]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==23]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==24]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==25]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==26]),useNA = "ifany")
# table(unlist(NAMES[A_corres$level1_match==27]),useNA = "ifany")
```

Algoritmo que permite navegar en toda la estructura de los xml. Basado
en 2 tablas:

1.  tabla que describe la jerarquía de los campos potenciales
2.  tabla que describe la presencia de los campos para los registros

Note: the following function get the elements from a recursive path

``` r
recPathList <- function(listNavig, path) {
    x = listNavig
    for (i in path) x <- x[[i]]
    return(x)
}
# example
```

Lo que hacemos primero es crear una matriz que contiene todo los paths,
nivel por nivel que existen en la lista representando el XML. Anotar:
cuando el nivel siguiente no es una lista, no fila está añadida.

``` r
require(collapse)
```

    ## Loading required package: collapse

    ## collapse 2.0.19, see ?`collapse-package` or ?`collapse-documentation`

    ## 
    ## Attaching package: 'collapse'

    ## The following object is masked from 'package:stats':
    ## 
    ##     D

``` r
listStruct <- matrix(data = c(1:length(xml_list), rep(NA, length(xml_list) *
    (ldepth(xml_list) - 1))), nrow = length(xml_list), ncol = ldepth(xml_list))
findNextLevelPaths <- function(li, pathParent, maxDepth) {
    if (!is.list(recPathList(li, pathParent))) {
        return(NULL)
    }
    LN <- length(recPathList(li, pathParent))
    return(cbind(matrix(data = pathParent, nrow = LN, byrow = T, ncol = length(pathParent)),
        1:LN, matrix(NA, nrow = LN, ncol = maxDepth - (length(pathParent) +
            1))))
}
for (i in 2:ncol(listStruct)) {
    cat("number of parents", sum(apply(listStruct, 1, function(x) length(na.omit(x))) ==
        (i - 1)), "\n")
    listStruct <- rbind(listStruct, Reduce(rbind, apply(listStruct[apply(listStruct,
        1, function(x) length(na.omit(x))) == (i - 1), ], 1, function(p,
        l, ml) {
        p = p[!is.na(p)]
        findNextLevelPaths(l, p, ml)
    }, l = xml_list, ml = ncol(listStruct), simplify = F)))
}
```

    ## number of parents 1050 
    ## number of parents 3150 
    ## number of parents 26793 
    ## number of parents 96966 
    ## number of parents 101621 
    ## number of parents 91287 
    ## number of parents 8511 
    ## number of parents 1350

Now let’s apply a function to get transform this matrix in a name
matrix.

``` r
nameCurrentLevel <- apply(listStruct[apply(listStruct, 1, function(x) length(na.omit(x))) >
    1, ], 1, function(x, li) {
    A <- na.omit(x)
    last <- A[length(A)]
    path <- A[-length(A)]
    names(recPathList(li, path))[last]
}, li = xml_list)
nameCurrentLevel[(length(nameCurrentLevel) - 50):length(nameCurrentLevel)]
```

    ##  [1] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ##  [9] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ## [17] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ## [25] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ## [33] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ## [41] ".attrs" "text"   ".attrs" "text"   ".attrs" "text"   ".attrs" "text"  
    ## [49] ".attrs" "text"   ".attrs"

``` r
allNames <- matrix(NA, nrow = nrow(listStruct), ncol = ncol(listStruct) -
    1)
for (i in 1:nrow(listStruct)) {
    if (i%%10000 == 0)
        cat(i, "/", nrow(listStruct), "\n")
    for (j in 2:max(2, length(na.omit(listStruct[i, ])))) {

        path <- listStruct[i, 1:(j - 1)]
        last <- listStruct[i, j]
        allNames[i, j - 1] <- names(recPathList(xml_list, path))[last]
    }
}
```

    ## 10000 / 331960 
    ## 20000 / 331960 
    ## 30000 / 331960 
    ## 40000 / 331960 
    ## 50000 / 331960 
    ## 60000 / 331960 
    ## 70000 / 331960 
    ## 80000 / 331960 
    ## 90000 / 331960 
    ## 100000 / 331960 
    ## 110000 / 331960 
    ## 120000 / 331960 
    ## 130000 / 331960 
    ## 140000 / 331960 
    ## 150000 / 331960 
    ## 160000 / 331960 
    ## 170000 / 331960 
    ## 180000 / 331960 
    ## 190000 / 331960 
    ## 200000 / 331960 
    ## 210000 / 331960 
    ## 220000 / 331960 
    ## 230000 / 331960 
    ## 240000 / 331960 
    ## 250000 / 331960 
    ## 260000 / 331960 
    ## 270000 / 331960 
    ## 280000 / 331960 
    ## 290000 / 331960 
    ## 300000 / 331960 
    ## 310000 / 331960 
    ## 320000 / 331960 
    ## 330000 / 331960

Desde el nivel 2 hasta maximo, determinamos cual es el parent:

``` r
level <- apply(listStruct, 1, function(x) length(na.omit(x)))
parent <- integer(nrow(listStruct))
for (i in 2:max(level)) {
    m <- match(apply(listStruct[level == i, ], 1, function(x) {
        x[which.max(which(!is.na(x)))] <- NA
        return(x)
    }, simplify = F), split(listStruct[level == (i - 1), ], row(listStruct[level ==
        (i - 1), ])))
    parent[level == i] <- which(level == (i - 1))[m]
}
```

Cuales son los hijos directos?

``` r
directChildren <- list()
for (i in 1:length(parent)) {
    directChildren[[i]] <- which(parent == i)
}
```

Cuales son los path que contienen una lista

``` r
contList <- apply(listStruct, 1, function(x, li) {
    path = na.omit(x)
    return(is.list(recPathList(li, path)))
}, li = xml_list)
```

Cuales son los casos que no contienen listas, pero son nulos:

``` r
contNull <- apply(listStruct, 1, function(x, li) {
    path = na.omit(x)
    return(is.null(recPathList(li, path)))
}, li = xml_list)
noListButNull <- !contList & contNull
sum(!contList)
```

    ## [1] 223595

``` r
sum(noListButNull)
```

    ## [1] 1123

``` r
sum(!contList & !contNull)
```

    ## [1] 222472

``` r
# which of listStruct is a non-null, non-list value
leaves <- which(!contList & !contNull)
# table of unique variable names
un_leaves <- unique(allNames[leaves, ])
# correspondence between non-null, non-list values and unique
# variable names
m <- match(split(allNames[leaves, ], row(allNames[leaves, ])), split(un_leaves,
    row(un_leaves)))
# Correspondence between listStruct and unique variable names
corres_leaves <- integer(nrow(listStruct))
corres_leaves[leaves] <- m
```

``` r
NAMES <- apply(un_leaves, 1, function(x) paste(na.omit(x), collapse = "."))
nb_byVar <- table(m)
names(nb_byVar) <- NAMES
nb_byVar[order(nb_byVar)]
```

    ##                                           additionalMetadata.metadata.gbif.formationPeriod 
    ##                                                                                          1 
    ##                                                       dataset.maintenance.description.para 
    ##                                                                                          1 
    ##                              dataset.coverage.temporalCoverage.singleDateTime.calendarDate 
    ##                                                                                          3 
    ##                         additionalMetadata.metadata.gbif.jgtiCuratorialUnit.jgtiUnits.text 
    ##                                                                                         12 
    ##                       additionalMetadata.metadata.gbif.jgtiCuratorialUnit.jgtiUnits..attrs 
    ##                                                                                         12 
    ##                                                                dataset.contact.userId.text 
    ##                                                                                         28 
    ##                                                              dataset.contact.userId..attrs 
    ##                                                                                         28 
    ##                                                        dataset.associatedParty.userId.text 
    ##                                                                                         29 
    ##                                                      dataset.associatedParty.userId..attrs 
    ##                                                                                         29 
    ##                                                      dataset.project.personnel.userId.text 
    ##                                                                                         29 
    ##                                                    dataset.project.personnel.userId..attrs 
    ##                                                                                         29 
    ##                                                       dataset.metadataProvider.userId.text 
    ##                                                                                         33 
    ##                                                     dataset.metadataProvider.userId..attrs 
    ##                                                                                         33 
    ##                                                  additionalMetadata.metadata.gbif.citation 
    ##                                                                                         37 
    ##                                                                dataset.creator.userId.text 
    ##                                                                                         37 
    ##                                                              dataset.creator.userId..attrs 
    ##                                                                                         37 
    ##               additionalMetadata.metadata.gbif.jgtiCuratorialUnit.jgtiUnitRange.beginRange 
    ##                                                                                         43 
    ##                 additionalMetadata.metadata.gbif.jgtiCuratorialUnit.jgtiUnitRange.endRange 
    ##                                                                                         43 
    ##                                           additionalMetadata.metadata.gbif.resourceLogoUrl 
    ##                                                                                         44 
    ##                           additionalMetadata.metadata.gbif.jgtiCuratorialUnit.jgtiUnitType 
    ##                                                                                         55 
    ##                                                              dataset.project.abstract.para 
    ##                                                                                        103 
    ##                                                         dataset.contact.address.postalCode 
    ##                                                                                        109 
    ## additionalMetadata.metadata.gbif.physical.dataFormat.externallyDefinedFormat.formatVersion 
    ##                                                                                        118 
    ##                                                         dataset.creator.address.postalCode 
    ##                                                                                        124 
    ##                                                                     dataset.project..attrs 
    ##                                                                                        125 
    ##                                                dataset.metadataProvider.address.postalCode 
    ##                                                                                        129 
    ##                                            dataset.intellectualRights.para.ulink.citetitle 
    ##                                                                                        319 
    ##                                               dataset.intellectualRights.para.ulink..attrs 
    ##                                                                                        319 
    ##                                                 dataset.associatedParty.address.postalCode 
    ##                                                                                        443 
    ##                                                                dataset.additionalInfo.para 
    ##                                                                                        466 
    ##                                                                  dataset.creator.onlineUrl 
    ##                                                                                        484 
    ##                                                         dataset.metadataProvider.onlineUrl 
    ##                                                                                        489 
    ##                                                                  dataset.contact.onlineUrl 
    ##                                                                                        603 
    ##                                       additionalMetadata.metadata.gbif.physical.objectName 
    ##                                                                                        616 
    ##                                additionalMetadata.metadata.gbif.physical.characterEncoding 
    ##                                                                                        616 
    ##    additionalMetadata.metadata.gbif.physical.dataFormat.externallyDefinedFormat.formatName 
    ##                                                                                        616 
    ##                     additionalMetadata.metadata.gbif.physical.distribution.online.url.text 
    ##                                                                                        616 
    ##                   additionalMetadata.metadata.gbif.physical.distribution.online.url..attrs 
    ##                                                                                        616 
    ##                                additionalMetadata.metadata.gbif.specimenPreservationMethod 
    ##                                                                                        621 
    ##                                                       dataset.intellectualRights.para.text 
    ##                                                                                        638 
    ##                                            dataset.methods.qualityControl.description.para 
    ##                                                                                        650 
    ##                                                            dataset.intellectualRights.para 
    ##                                                                                        725 
    ##                     additionalMetadata.metadata.gbif.collection.parentCollectionIdentifier 
    ##                                                                                        730 
    ##                           additionalMetadata.metadata.gbif.collection.collectionIdentifier 
    ##                                                                                        817 
    ##                                         dataset.project.designDescription.description.para 
    ##                                                                                        820 
    ##                                 additionalMetadata.metadata.gbif.collection.collectionName 
    ##                                                                                        828 
    ##                                                                      dataset.creator.phone 
    ##                                                                                        910 
    ##                                                  additionalMetadata.metadata.gbif.replaces 
    ##                                                                                        916 
    ##                                                             dataset.metadataProvider.phone 
    ##                                                                                        918 
    ##                            dataset.project.studyAreaDescription.descriptor.descriptorValue 
    ##                                                                                        985 
    ##                                                                dataset.distribution..attrs 
    ##                                                                                        986 
    ##                                                       dataset.distribution.online.url.text 
    ##                                                                                        986 
    ##                                                     dataset.distribution.online.url..attrs 
    ##                                                                                        986 
    ##                                     dataset.project.studyAreaDescription.descriptor..attrs 
    ##                                                                                        987 
    ##                                                               dataset.project.funding.para 
    ##                                                                                        993 
    ##                                                                       dataset.purpose.para 
    ##                                                                                        995 
    ##                                                      dataset.creator.address.deliveryPoint 
    ##                                                                                        996 
    ##                                             additionalMetadata.metadata.gbif.citation.text 
    ##                                                                                       1000 
    ##                                           additionalMetadata.metadata.gbif.citation..attrs 
    ##                                                                                       1000 
    ##                                                                      dataset.project.title 
    ##                                                                                       1002 
    ##                                             dataset.maintenance.maintenanceUpdateFrequency 
    ##                                                                                       1006 
    ##                                             dataset.metadataProvider.address.deliveryPoint 
    ##                                                                                       1031 
    ##                                                                      dataset.contact.phone 
    ##                                                                                       1033 
    ##                                                      dataset.metadataProvider.positionName 
    ##                                                                                       1043 
    ##                                          dataset.metadataProvider.individualName.givenName 
    ##                                                                                       1046 
    ##                                          dataset.methods.sampling.samplingDescription.para 
    ##                                                                                       1047 
    ##                                      dataset.methods.sampling.studyExtent.description.para 
    ##                                                                                       1047 
    ##                                                               dataset.contact.positionName 
    ##                                                                                       1049 
    ##                                                                                     .attrs 
    ##                                                                                       1050 
    ##                                                                            dataset.pubDate 
    ##                                                                                       1050 
    ##                                                                           dataset.language 
    ##                                                                                       1050 
    ##                                                                         dataset.title.text 
    ##                                                                                       1050 
    ##                                                                       dataset.title..attrs 
    ##                                                                                       1050 
    ##                                  dataset.coverage.geographicCoverage.geographicDescription 
    ##                                                                                       1050 
    ##                                                   dataset.contact.individualName.givenName 
    ##                                                                                       1050 
    ##                                                 additionalMetadata.metadata.gbif.dateStamp 
    ##                                                                                       1050 
    ##                                            additionalMetadata.metadata.gbif.hierarchyLevel 
    ##                                                                                       1050 
    ##             dataset.coverage.geographicCoverage.boundingCoordinates.westBoundingCoordinate 
    ##                                                                                       1050 
    ##             dataset.coverage.geographicCoverage.boundingCoordinates.eastBoundingCoordinate 
    ##                                                                                       1050 
    ##            dataset.coverage.geographicCoverage.boundingCoordinates.northBoundingCoordinate 
    ##                                                                                       1050 
    ##            dataset.coverage.geographicCoverage.boundingCoordinates.southBoundingCoordinate 
    ##                                                                                       1050 
    ##                                                      dataset.creator.electronicMailAddress 
    ##                                                                                       1051 
    ##                                                               dataset.creator.positionName 
    ##                                                                                       1055 
    ##                                                                      dataset.abstract.para 
    ##                                                                                       1073 
    ##                                                 dataset.creator.address.administrativeArea 
    ##                                                                                       1074 
    ##                                             dataset.metadataProvider.electronicMailAddress 
    ##                                                                                       1083 
    ##                                                   dataset.creator.individualName.givenName 
    ##                                                                                       1083 
    ##                                                               dataset.creator.address.city 
    ##                                                                                       1086 
    ##                                                            dataset.creator.address.country 
    ##                                                                                       1087 
    ##                                                     dataset.creator.individualName.surName 
    ##                                                                                       1088 
    ##                                                           dataset.creator.organizationName 
    ##                                                                                       1089 
    ##                                        dataset.metadataProvider.address.administrativeArea 
    ##                                                                                       1090 
    ##                                                   dataset.metadataProvider.address.country 
    ##                                                                                       1092 
    ##                                            dataset.metadataProvider.individualName.surName 
    ##                                                                                       1094 
    ##                                                      dataset.metadataProvider.address.city 
    ##                                                                                       1094 
    ##                                                             dataset.project.personnel.role 
    ##                                                                                       1094 
    ##                                                  dataset.metadataProvider.organizationName 
    ##                                                                                       1097 
    ##                                                      dataset.contact.electronicMailAddress 
    ##                                                                                       1098 
    ##                                                      dataset.contact.address.deliveryPoint 
    ##                                                                                       1100 
    ##                                         dataset.project.personnel.individualName.givenName 
    ##                                                                                       1108 
    ##                                                 dataset.contact.address.administrativeArea 
    ##                                                                                       1110 
    ##                                                            dataset.contact.address.country 
    ##                                                                                       1111 
    ##                                                               dataset.contact.address.city 
    ##                                                                                       1113 
    ##                                           dataset.project.personnel.individualName.surName 
    ##                                                                                       1114 
    ##                                                           dataset.contact.organizationName 
    ##                                                                                       1115 
    ##                                                     dataset.contact.individualName.surName 
    ##                                                                                       1115 
    ##                      dataset.coverage.temporalCoverage.rangeOfDates.beginDate.calendarDate 
    ##                                                                                       1174 
    ##                        dataset.coverage.temporalCoverage.rangeOfDates.endDate.calendarDate 
    ##                                                                                       1174 
    ##                                                                dataset.alternateIdentifier 
    ##                                                                                       1176 
    ##                                dataset.coverage.taxonomicCoverage.generalTaxonomicCoverage 
    ##                                                                                       1291 
    ##                                additionalMetadata.metadata.gbif.bibliography.citation.text 
    ##                                                                                       1887 
    ##                              additionalMetadata.metadata.gbif.bibliography.citation..attrs 
    ##                                                                                       1887 
    ##                                                dataset.methods.methodStep.description.para 
    ##                                                                                       2191 
    ##                                                          dataset.associatedParty.onlineUrl 
    ##                                                                                       3111 
    ##                                                        dataset.keywordSet.keywordThesaurus 
    ##                                                                                       3661 
    ##                                                              dataset.associatedParty.phone 
    ##                                                                                       3939 
    ##                                                       dataset.associatedParty.positionName 
    ##                                                                                       4202 
    ##                                           dataset.associatedParty.individualName.givenName 
    ##                                                                                       4241 
    ##                                              dataset.associatedParty.address.deliveryPoint 
    ##                                                                                       4546 
    ##                                              dataset.associatedParty.electronicMailAddress 
    ##                                                                                       4832 
    ##                                         dataset.associatedParty.address.administrativeArea 
    ##                                                                                       5297 
    ##                                                       dataset.associatedParty.address.city 
    ##                                                                                       5491 
    ##                                                    dataset.associatedParty.address.country 
    ##                                                                                       5575 
    ##                                                               dataset.associatedParty.role 
    ##                                                                                       5718 
    ##                                                   dataset.associatedParty.organizationName 
    ##                                                                                       5727 
    ##                                             dataset.associatedParty.individualName.surName 
    ##                                                                                       5788 
    ##                      dataset.coverage.taxonomicCoverage.taxonomicClassification.commonName 
    ##                                                                                       5790 
    ##                                     additionalMetadata.metadata.gbif.bibliography.citation 
    ##                                                                                       7105 
    ##                                                                 dataset.keywordSet.keyword 
    ##                                                                                      10059 
    ##                   dataset.coverage.taxonomicCoverage.taxonomicClassification.taxonRankName 
    ##                                                                                      24713 
    ##                  dataset.coverage.taxonomicCoverage.taxonomicClassification.taxonRankValue 
    ##                                                                                      25668

``` r
# View(un_leaves[do.call('order',as.data.frame(un_leaves)),])
```

Para cada variable (hoja), necesitamos saber:

- cuantas veces aparece?
- En cuantos registros aparece?
- cual es el maximo de las repeticiones en un registro?
- cual es el minimo/maximo de la longitud del vector de valores?
- ejemplos de valores

``` r
nbOccurrences <- table(corres_leaves[corres_leaves != 0])
nbReg <- tapply(listStruct[, 1], corres_leaves, function(x) length(unique(x)))[-1]
nbRepMin <- apply(Reduce(rbind, tapply(factor(corres_leaves), listStruct[,
    1], table)), 2, function(x) min(na.omit(x[x > 0])))[-1]
nbRepMax <- apply(Reduce(rbind, tapply(factor(corres_leaves), listStruct[,
    1], table)), 2, max)[-1]


rangeLN <- by(listStruct[corres_leaves != 0, ], corres_leaves[corres_leaves !=
    0], FUN = function(tab, ls_xml) {
    ls_byVar <- apply(tab, 1, FUN = function(x, l_x) recPathList(ls_xml,
        na.omit(x)), l_x = ls_xml, simplify = F)
    return(range(sapply(ls_byVar, length)))
}, ls_xml = xml_list)
len_min <- sapply(rangeLN, min)
len_max <- sapply(rangeLN, max)

subNames <- by(listStruct[corres_leaves != 0, ], corres_leaves[corres_leaves !=
    0], FUN = function(tab, ls_xml) {
    subN <- unique(unlist(lapply(apply(tab, 1, FUN = function(x, l_x) recPathList(ls_xml,
        na.omit(x)), l_x = ls_xml, simplify = F), names)))
    return(paste(subN, sep = "|", collapse = "|"))
}, ls_xml = xml_list)

examples <- as.list(by(listStruct, corres_leaves, FUN = function(tab, ls_xml) {
    ls_byVar <- apply(tab, 1, FUN = function(x, l_x) recPathList(ls_xml,
        na.omit(x)), l_x = ls_xml)
}, ls_xml = xml_list)[-1])
isAttr <- grepl("\\.attr", NAMES)
```

Now we export a csv file to be able to analyse and name the variables:

``` r
un_leaves <- data.frame(id = 1:nrow(un_leaves), un_leaves, isAttr, nbOccurrences,
    nbReg, nbRepMin, nbRepMax, len_min, len_max, subNames)
un_leaves <- un_leaves[do.call("order", as.list(un_leaves[2:ncol(un_leaves)])),
    ]

write.csv(un_leaves, file = "../../../data_metadatos_catalogos/ceiba_un_leaves.csv")
```

# 3 Exportation of a table with values and references (dataset and variables)

What we have got is:

- the table `un_leaves` which contains many characteristics of the
  different variables
- `listStruct` which contains all the paths in rows
- `corres_leaves`, which corresponds one on one to listStruct and which
  gives 0 when the path does not go to a “leaf” and gives the id of the
  table `un_leaves` when it is a leaf
- `xml_list` which contains all the info from the xml files, and might
  be accessed through the function `recPathList` with the path from
  `listStruct`
- `parent` which gives, for each of the line of `listStruct` the parent
  line, in `listStruct` as well
- `addresses_xml` which contains, in the first column, the system path
  of the files xml, on the same order as the column 1 from `listStruct`:
  we can extract the name of the folder from there…

One of the difficulties we could have to extract the table of values is
that some leaves (some of the .attr ones only) have more than one value
on the leaves

``` r
folder <- gsub("^.*/", "", dirname(addresses_xml$file))
ref <- which(corres_leaves != 0)
res <- Reduce(rbind, lapply(ref, function(x, f, lS, cl, xl, p, ul) {
    val <- recPathList(xl, na.omit(lS[x, ]))
    nameVal <- names(val)
    if (is.null(nameVal)) {
        nameVal <- NA
    }
    return(data.frame(ref_struct = x, parent = p[x], folder = f[lS[x, 1]],
        id_var = cl[x], subname = nameVal, value = as.character(val)))
}, f = folder, lS = listStruct, cl = corres_leaves, xl = xml_list, p = parent,
    ul = un_leaves))
save(res, file = "../../../data_metadatos_catalogos/tab_variable.RData")
```
